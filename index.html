<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0, minimum-scale=1.0">
    <title>Animation Controller</title>
    <style>
        body {
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 0;
            overflow: hidden;
            background-color: black;
            position: relative;
            user-select: none;
        }
        #gameArea {
            position: relative;
            width: 82vmin;
            height: 82vmin;
            background-color: #ddd;
            border-radius: 3vh;
            overflow: hidden;
        }
        #player {
            position: absolute;
            width: 100px;
            height: 100px;
            transform: translate(-50%, -50%);
            transition: top 0.1s, left 0.1s;
        }
        .A {
            background-image: url('spritesheet.png');
            background-repeat: no-repeat;
            display: block;
        }
        .SSW1 { background-position: -200px -0px; }
        .SSW2 { background-position: -200px -100px; }
        .SSW3 { background-position: -200px -200px; }
        .SW1 { background-position: -300px -0px; }
        .SW2 { background-position: -300px -100px; }
        .SW3 { background-position: -300px -200px; }
        .SWW1 { background-position: -400px -0px; }
        .SWW2 { background-position: -400px -100px; }
        .SWW3 { background-position: -400px -200px; }
        .W1 { background-position: -500px -0px; }
        .W2 { background-position: -500px -100px; }
        .W3 { background-position: -500px -200px; }
        .NWW1 { background-position: -600px -0px; }
        .NWW2 { background-position: -600px -100px; }
        .NWW3 { background-position: -600px -200px; }
        .NW1 { background-position: -700px -0px; }
        .NW2 { background-position: -700px -100px; }
        .NW3 { background-position: -700px -200px; }
        .NNW1 { background-position: -800px -0px; }
        .NNW2 { background-position: -800px -100px; }
        .NNW3 { background-position: -800px -200px; }
        .N1 { background-position: -900px -0px; }
        .N2 { background-position: -900px -100px; }
        .N3 { background-position: -900px -200px; }
        .NNE1 { background-position: -1000px -0px; }
        .NNE2 { background-position: -1000px -100px; }
        .NNE3 { background-position: -1000px -200px; }
        .NE1 { background-position: -1100px -0px; }
        .NE2 { background-position: -1100px -100px; }
        .NE3 { background-position: -1100px -200px; }
        .NEE1 { background-position: -1200px -0px; }
        .NEE2 { background-position: -1200px -100px; }
        .NEE3 { background-position: -1200px -200px; }
        .E1 { background-position: -1300px -0px; }
        .E2 { background-position: -1300px -100px; }
        .E3 { background-position: -1300px -200px; }
        .SEE1 { background-position: -1400px -0px; }
        .SEE2 { background-position: -1400px -100px; }
        .SEE3 { background-position: -1400px -200px; }
        .SE1 { background-position: -1500px -0px; }
        .SE2 { background-position: -1500px -100px; }
        .SE3 { background-position: -1500px -200px; }
        .SSE1 { background-position: -1600px -0px; }
        .SSE2 { background-position: -1600px -100px; }
        .SSE3 { background-position: -1600px -200px; }
        .S1 { background-position: -100px -0px; }
        .S2 { background-position: -100px -100px; }
        .S3 { background-position: -100px -200px; }
        .idle1 { background-position: -0px -0px; }
        .idle2 { background-position: -0px -100px; }
        .idle3 { background-position: -0px -200px; }
        
        #joypad {
            position: absolute;
            bottom: 10%;
            left: 10%;
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
        }
        #joypadInner {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background-color: rgba(255, 255, 255, 0.7);
            position: absolute;
            pointer-events: none;
        }

        #chaser {
    position: absolute;
    width: 100px;
    height: 100px;
    background-color: transparent;
    transform: translate(-50%, -50%);
    transition: top 0.1s, left 0.1s;
}
    </style>
</head>
<body>
    <div id="gameArea">
        <div id="player" class="A"></div>
        <div id="chaser" class="A"></div>
    
    </div>
    <div id="joypad">
        <div id="joypadInner"></div>
    </div>
<script>
const player = document.getElementById('player');
const joypad = document.getElementById('joypad');
const joypadInner = document.getElementById('joypadInner');
const chaser = document.getElementById('chaser');
const directions = { SSW: 'SSW', SW: 'SW', W: 'W', NW: 'NW', N: 'N', NE: 'NE', E: 'E', SEE: 'SEE', SE: 'SE', S: 'S', SWW: 'SWW', NWW: 'NWW', SSE: 'SSE', NNE: 'NNE', NNW: 'NNW', NEE: 'NEE' };
let posX = 50, posY = 50, velocityX = 0, velocityY = 0, joystickAngle = 0, joystickDistance = 0, animationFrame = 1, idleFrame = 1, lastAnimationTime = 0, lastChaserAnimationTime = 0, gamepadIndex = null;
const friction = 0.06, maxSpeed = 0.8, maxFrames = 3, maxIdleFrames = 3, chaserSpeed = 0.02, animationFrameRate = 5, animationInterval = 1000 / animationFrameRate;
let joypadCenter = { x: 0, y: 0 }, joypadRadius = joypad.offsetWidth / 2, joystickActive = false, isIdle = true, chaserDirection = 'S';
let chaserX = 20, chaserY = 20, chaserVelocityX = 0, chaserVelocityY = 0;

function updateJoypadCenter() {
    const rect = joypad.getBoundingClientRect();
    joypadCenter.x = rect.left + joypad.offsetWidth / 2;
    joypadCenter.y = rect.top + joypad.offsetHeight / 2;
}

function moveJoypadInner(x, y) {
    const dx = x - joypadCenter.x, dy = y - joypadCenter.y;
    joystickDistance = Math.min(Math.sqrt(dx * dx + dy * dy), joypadRadius);
    joystickAngle = Math.atan2(dy, dx);
    joypadInner.style.left = `${Math.cos(joystickAngle) * joystickDistance + joypadRadius - joypadInner.offsetWidth / 2}px`;
    joypadInner.style.top = `${Math.sin(joystickAngle) * joystickDistance + joypadRadius - joypadInner.offsetHeight / 2}px`;
    calculateDirectionFromJoystick(joystickAngle);
    joystickActive = true;
}

function calculateDirectionFromJoystick(angle) {
    const angleDeg = (angle * (180 / Math.PI) + 360) % 360;
    const directionsArray = ['E', 'SEE', 'SE', 'SSE', 'S', 'SSW', 'SW', 'SWW', 'W', 'NWW', 'NW', 'NNW', 'N', 'NNE', 'NE', 'NEE'];
    const step = 360 / directionsArray.length;
    direction = directionsArray[Math.floor((angleDeg + step / 2) / step)];
}

function updateAnimation(timestamp, targetElement, direction, frameRate, isIdle) {
    if (timestamp - (isIdle ? lastAnimationTime : lastChaserAnimationTime) > animationInterval) {
        if (isIdle) {
            targetElement.className = `A idle${idleFrame}`;
            idleFrame = (idleFrame % maxIdleFrames) + 1;
        } else {
            targetElement.className = `A ${directions[direction]}${frameRate}`;
            frameRate = (frameRate % maxFrames) + 1;
        }
        lastAnimationTime = timestamp;
    }
}

function updatePosition() {
    if (joystickActive) {
        velocityX = Math.cos(joystickAngle) * (joystickDistance / joypadRadius) * maxSpeed;
        velocityY = Math.sin(joystickAngle) * (joystickDistance / joypadRadius) * maxSpeed;
    } else {
        velocityX *= (1 - friction);
        velocityY *= (1 - friction);
    }
    posX = Math.max(0, Math.min(100, posX + velocityX));
    posY = Math.max(0, Math.min(100, posY + velocityY));

    player.style.left = `${posX}%`;
    player.style.top = `${posY}%`;

    isIdle = !joystickActive && Math.abs(velocityX) < 0.01 && Math.abs(velocityY) < 0.01;
}

function handleGamepadInput() {
    if (gamepadIndex === null) return;

    const gamepad = navigator.getGamepads()[gamepadIndex];
    if (!gamepad) return;

    const threshold = 0.2;
    const axisX = gamepad.axes[0], axisY = gamepad.axes[1];

    if (Math.abs(axisX) > threshold || Math.abs(axisY) > threshold) {
        joystickAngle = Math.atan2(axisY, axisX);
        joystickDistance = Math.min(Math.sqrt(axisX ** 2 + axisY ** 2), 1) * joypadRadius;
        calculateDirectionFromJoystick(joystickAngle);
        joystickActive = true;
    } else {
        joystickActive = false;
    }
}

function connectGamepad(event) {
    gamepadIndex = event.gamepad.index;
    console.log(`Gamepad connected: ${event.gamepad.id}`);
    joypad.style.opacity = '0';
}

function disconnectGamepad(event) {
    console.log(`Gamepad disconnected: ${event.gamepad.id}`);
    if (gamepadIndex === event.gamepad.index) {
        gamepadIndex = null;
    }
    joypad.style.opacity = '1';
}

function updateChaser(timestamp) {
    const dx = posX - chaserX, dy = posY - chaserY, distance = Math.sqrt(dx * dx + dy * dy);

    if (distance > 0.5) {
        chaserVelocityX += (dx / distance) * chaserSpeed;
        chaserVelocityY += (dy / distance) * chaserSpeed;
    }

    chaserVelocityX *= (1 - friction);
    chaserVelocityY *= (1 - friction);

    chaserX = Math.max(0, Math.min(100, chaserX + chaserVelocityX));
    chaserY = Math.max(0, Math.min(100, chaserY + chaserVelocityY));

    chaser.style.left = `${chaserX}%`;
    chaser.style.top = `${chaserY}%`;

    if (Math.abs(chaserVelocityX) > 0.01 || Math.abs(chaserVelocityY) > 0.01) {
        chaserDirection = calculateDirectionFromVelocity(chaserVelocityX, chaserVelocityY);
    }

    updateAnimation(timestamp, chaser, chaserDirection, chaserAnimationFrame, false);
}

function calculateDirectionFromVelocity(vx, vy) {
    const angle = Math.atan2(vy, vx);
    const angleDeg = (angle * (180 / Math.PI) + 360) % 360;

    const directionsArray = ['E', 'SEE', 'SE', 'SSE', 'S', 'SSW', 'SW', 'SWW', 'W', 'NWW', 'NW', 'NNW', 'N', 'NNE', 'NE', 'NEE'];
    const step = 360 / directionsArray.length;
    return directionsArray[Math.floor((angleDeg + step / 2) / step)];
}

function gameLoop(timestamp) {
    handleGamepadInput();
    updatePosition();
    updateChaser(timestamp);
    updateAnimation(timestamp, player, direction, animationFrame, isIdle);
    requestAnimationFrame(gameLoop);
}

window.addEventListener('gamepadconnected', connectGamepad);
window.addEventListener('gamepaddisconnected', disconnectGamepad);

joypad.addEventListener('touchstart', (event) => {
    updateJoypadCenter();
    moveJoypadInner(event.touches[0].clientX, event.touches[0].clientY);
});

joypad.addEventListener('touchmove', (event) => {
    moveJoypadInner(event.touches[0].clientX, event.touches[0].clientY);
});

joypad.addEventListener('touchend', () => {
    if (event.touches.length === 0) {
        joystickActive = false;
        velocityX = 0;
        velocityY = 0;
        joypadInner.style.left = `${joypadRadius - joypadInner.offsetWidth / 2}px`;
        joypadInner.style.top = `${joypadRadius - joypadInner.offsetHeight / 2}px`;
    }
});

gameLoop(0);
</script>
</body>
</html>
